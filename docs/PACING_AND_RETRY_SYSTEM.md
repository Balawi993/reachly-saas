# ๐ฏ ูุธุงู Pacing & Retry - ุงูุดุฑุญ ุงููุงูู

## ุงููุดุงูู ุงูุชู ุชู ุฅุตูุงุญูุง โ

### 1. โ ุงููุดููุฉ: Retry Attempts ูุง ูุนูู
**ูุจู ุงูุฅุตูุงุญ:**
- ุนูุฏ ูุดู ุงูุฑุณุงูุฉุ ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `failed` ูุจุงุดุฑุฉ
- ูุง ูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุฃุจุฏุงู
- `pacing_retry_attempts` ูุงู ูุฌุฑุฏ ุฑูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุฏูู ุงุณุชุฎุฏุงู

**ุจุนุฏ ุงูุฅุตูุงุญ:**
- ูุชู ุชุชุจุน ุนุฏุฏ ุงููุญุงููุงุช ููู ูุฏู ูู `retry_count`
- ุนูุฏ ุงููุดูุ ูุชู ุฒูุงุฏุฉ `retry_count` ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
- ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `failed` ููุท ุจุนุฏ ุงุณุชููุงุฏ ุฌููุน ุงููุญุงููุงุช

### 2. โ ุงููุดููุฉ: ุงูุฑุณุงุฆู ุงููุงุฌุญุฉ ูุฏ ุชุชูุฑุฑ
**ูุจู ุงูุฅุตูุงุญ:**
- ูุง ููุฌุฏ ูุญุต ูููุน ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณ ุงููุณุชุฎุฏู ูุฑุชูู
- ูููู ุฃู ูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณ ุงูุดุฎุต ุนุฏุฉ ูุฑุงุช ูู ููุณ ุงูุญููุฉ

**ุจุนุฏ ุงูุฅุตูุงุญ:**
- ูุชู ูุญุต ูุง ุฅุฐุง ุชู ุงูุฅุฑุณุงู ุจุงููุนู ููุฐุง ุงููุณุชุฎุฏู
- ุฅุฐุง ูุงูุช ุงูุญุงูุฉ `sent`ุ ูุชู ุชุฎุทู ุงููุฏู ุชููุงุฆูุงู
- ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `skipped` ูุน ุฑุณุงูุฉ ุชูุถูุญูุฉ

### 3. โ ุงููุดููุฉ: Messages per Minute ูุง ููุญุชุฑู
**ูุจู ุงูุฅุตูุงุญ:**
- ูุงู ูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูู 5 ุซูุงูู ุจุบุถ ุงููุธุฑ ุนู ุงูุฅุนุฏุงุฏุงุช
- ูููู ุฅุฑุณุงู 12 ุฑุณุงูุฉ ูู ุงูุฏูููุฉ ุญุชู ูู ูุงู ุงูุฅุนุฏุงุฏ 3!

**ุจุนุฏ ุงูุฅุตูุงุญ:**
- ูุชู ุชุชุจุน ุงูุฑุณุงุฆู ุงููุฑุณูุฉ ูู ุขุฎุฑ 60 ุซุงููุฉ
- ูุง ูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ุฅุฐุง ูุตููุง ููุญุฏ ุงูุฃูุตู
- ูุชู ุงูุงูุชุธุงุฑ ุชููุงุฆูุงู ุญุชู ุชูุฑ ุฏูููุฉ

---

## ููู ูุนูู ูุธุงู Retry ุงูุฌุฏูุฏุ

### ูุซุงู ุนููู:

**ุงูุฅุนุฏุงุฏุงุช:**
```
Retry Attempts: 3
Messages per Minute: 3
Daily Cap: 50
```

**ุงูุณููุงุฑูู:**

#### ุงููุญุงููุฉ ุงูุฃููู (Attempt 1)
```
๐ค Sending to @user123 (1/3 per min, 1/50 today)
โ Failed: Rate limit exceeded
โ๏ธ  Failed attempt 1/3 to @user123 - will retry
```
- `retry_count` = 1
- `status` = 'pending' (ูุง ูุฒุงู)
- `last_attempt_at` = ุงูุขู

#### ุงููุญุงููุฉ ุงูุซุงููุฉ (Attempt 2)
```
๐ค Retry #2 to @user123 (2/3 per min, 2/50 today)
โ Failed: Connection timeout
โ๏ธ  Failed attempt 2/3 to @user123 - will retry
```
- `retry_count` = 2
- `status` = 'pending' (ูุง ูุฒุงู)
- `last_attempt_at` = ุงูุขู

#### ุงููุญุงููุฉ ุงูุซุงูุซุฉ (Attempt 3)
```
๐ค Retry #3 to @user123 (3/3 per min, 3/50 today)
โ Retry succeeded to @user123
```
- `retry_count` = 3
- `status` = 'sent' โ
- `sent_at` = ุงูุขู

#### ุฅุฐุง ูุดูุช ุฌููุน ุงููุญุงููุงุช:
```
๐ค Retry #3 to @user456 (1/3 per min, 4/50 today)
โ Failed: User not found
โ Failed permanently to @user456 after 3 attempts
```
- `retry_count` = 3
- `status` = 'failed' โ
- `error_message` = "User not found"

---

## ููู ูุนูู ูุธุงู Pacingุ

### 1. Messages per Minute (ุฑุณุงุฆู ูู ุงูุฏูููุฉ)

**ุงูุขููุฉ:**
- ูุชู ุญูุธ timestamp ููู ุฑุณุงูุฉ ูุฑุณูุฉ
- ูุจู ุฅุฑุณุงู ุฑุณุงูุฉ ุฌุฏูุฏุฉุ ูุชู ุญุณุงุจ ุนุฏุฏ ุงูุฑุณุงุฆู ูู ุขุฎุฑ 60 ุซุงููุฉ
- ุฅุฐุง ูุตููุง ููุญุฏุ ููุชุธุฑ ุญุชู ุชุฎุฑุฌ ุฃูุฏู ุฑุณุงูุฉ ูู ุงููุงูุฐุฉ ุงูุฒูููุฉ

**ูุซุงู:**
```
ุงูุฅุนุฏุงุฏ: 3 ุฑุณุงุฆู/ุฏูููุฉ

0:00 โ ุฑุณุงูุฉ #1 โ
0:20 โ ุฑุณุงูุฉ #2 โ
0:40 โ ุฑุณุงูุฉ #3 โ
0:50 โ ูุญุงููุฉ #4 โ (3/3 - ุงูุชุธุฑ)
1:01 โ ุฑุณุงูุฉ #4 โ (ุงูุฑุณุงูุฉ #1 ุฎุฑุฌุช ูู ุงููุงูุฐุฉ)
```

### 2. Daily Cap (ุงูุญุฏ ุงููููู)

**ุงูุขููุฉ:**
- ูุชู ุญุณุงุจ ุนุฏุฏ ูุญุงููุงุช ุงูุฅุฑุณุงู (ูุงุฌุญุฉ + ูุงุดูุฉ) ูู ุงูููู ุงูุญุงูู
- ุนูุฏ ุงููุตูู ููุญุฏุ ูุชู ุฅููุงู ุงูุญููุฉ ุชููุงุฆูุงู
- ูุชู ุงุญุชุณุงุจ ุงููุญุงููุงุช ุงููุงุดูุฉ ุฃูุถุงู ูุฃููุง ุชุณุชููู ูู Rate Limit

**ูุซุงู:**
```
ุงูุฅุนุฏุงุฏ: 50 ุฑุณุงูุฉ/ููู

ุงูููู:
- 40 ุฑุณุงูุฉ ูุงุฌุญุฉ
- 8 ุฑุณุงุฆู ูุงุดูุฉ (ูุน ุฅุนุงุฏุฉ ุงููุญุงููุฉ)
- ุงููุฌููุน: 48 ูุญุงููุฉ

ุงููุชุจูู: 2 ูุญุงููุฉ ููุท
```

### 3. Random Delay (ุงูุชุฃุฎูุฑ ุงูุนุดูุงุฆู)

**ุงูุขููุฉ:**
- ุจุนุฏ ูู ุฑุณุงูุฉ ูุงุฌุญุฉุ ูุชู ุงูุงูุชุธุงุฑ ููุฏุฉ ุนุดูุงุฆูุฉ
- ุงููุฏุฉ ุจูู `delayMin` ู `delayMax`
- ูุฌุนู ุงูุฅุฑุณุงู ูุจุฏู ุทุจูุนูุงู ูููุณ ุขููุงู

**ูุซุงู:**
```
ุงูุฅุนุฏุงุฏ: 15-30 ุซุงููุฉ

ุฑุณุงูุฉ #1 โ ุงูุชุธุงุฑ 18.3 ุซุงููุฉ
ุฑุณุงูุฉ #2 โ ุงูุชุธุงุฑ 24.7 ุซุงููุฉ
ุฑุณุงูุฉ #3 โ ุงูุชุธุงุฑ 29.1 ุซุงููุฉ
```

---

## Database Schema ุงูุฌุฏูุฏ

### ุฌุฏูู targets

```sql
CREATE TABLE targets (
  id INTEGER PRIMARY KEY,
  campaign_id INTEGER,
  username TEXT,
  handle TEXT,
  name TEXT,
  avatar TEXT,
  status TEXT DEFAULT 'pending',  -- pending, sent, failed, skipped
  retry_count INTEGER DEFAULT 0,   -- โ ุฌุฏูุฏ: ุนุฏุฏ ุงููุญุงููุงุช
  last_attempt_at DATETIME,        -- โ ุฌุฏูุฏ: ุขุฎุฑ ูุญุงููุฉ
  sent_at DATETIME,
  replied_at DATETIME,
  error_message TEXT
);
```

### ุญุงูุงุช ุงูู status

| Status | ุงููุตู | ูุชู ูุญุฏุซ |
|--------|-------|----------|
| `pending` | ูู ุงูุชุธุงุฑ ุงูุฅุฑุณุงู | ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ |
| `sent` | ุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ | ุจุนุฏ ุฅุฑุณุงู ูุงุฌุญ |
| `failed` | ูุดู ููุงุฆูุงู | ุจุนุฏ ุงุณุชููุงุฏ ุฌููุน ุงููุญุงููุงุช |
| `skipped` | ุชู ุงูุชุฎุทู | ุฅุฐุง ุชู ุงูุฅุฑุณุงู ุจุงููุนู ููุฐุง ุงููุณุชุฎุฏู |

---

## ููุทู ุงุฎุชูุงุฑ ุงููุฏู ุงูุชุงูู

```sql
SELECT * FROM targets
WHERE campaign_id = ? 
  AND status != 'sent'           -- โ ูู ูุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ
  AND retry_count < ?            -- โ ูุง ุฒุงูุช ููุงู ูุญุงููุงุช ูุชุจููุฉ
ORDER BY 
  CASE WHEN status = 'pending' THEN 0 ELSE 1 END,  -- โ ุฃููููุฉ ููุฌุฏูุฏ
  id ASC                         -- โ ุซู ุญุณุจ ุงูุชุฑุชูุจ
LIMIT 1
```

**ุงูุฃููููุงุช:**
1. ุงูุฃูุฏุงู ุงูุฌุฏูุฏุฉ (`pending`) ุฃููุงู
2. ุซู ุงูุฃูุฏุงู ุงููุงุดูุฉ ุงูุชู ูุง ุฒุงูุช ูุฏููุง ูุญุงููุงุช
3. ุญุณุจ ุชุฑุชูุจ ุงูุฅุถุงูุฉ (id)

---

## Logging ุงููุญุณูู

### ุฑุณุงูุฉ ุฌุฏูุฏุฉ
```
๐ค [Campaign 1] Sending to @user123 (1/3 per min, 5/50 today)
โ [Campaign 1] Sent to @user123 - waiting 18.3s
```

### ุฅุนุงุฏุฉ ูุญุงููุฉ
```
๐ค [Campaign 1] Retry #2 to @user456 (2/3 per min, 6/50 today)
โ [Campaign 1] Retry succeeded to @user456 - waiting 24.7s
```

### ูุดู ูุน ูุญุงููุงุช ูุชุจููุฉ
```
๐ค [Campaign 1] Retry #1 to @user789 (3/3 per min, 7/50 today)
โ๏ธ  [Campaign 1] Failed attempt 1/3 to @user789: Rate limit - will retry
```

### ูุดู ููุงุฆู
```
๐ค [Campaign 1] Retry #3 to @user999 (1/3 per min, 8/50 today)
โ [Campaign 1] Failed permanently to @user999 after 3 attempts: User not found
```

### ุชุฎุทู (ููุฑุฑ)
```
โญ๏ธ  [Campaign 1] Skipped @user111 - already sent in this campaign
```

### ูุตูู ููุญุฏ ุงููููู
```
โ๏ธ  Campaign 1 reached daily cap (50 attempts)
โธ๏ธ  Campaign 1 paused
```

---

## ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุชุญุฏูุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช

ุฅุฐุง ูุงู ูุฏูู ูุงุนุฏุฉ ุจูุงูุงุช ููุฌูุฏุฉ:
```bash
node migrate-add-retry-fields.js
```

ุฃู ุงุจุฏุฃ ูู ุงูุตูุฑ:
```bash
npm run reset-db
```

### 2. ุฅูุดุงุก ุญููุฉ ุจุฅุนุฏุงุฏุงุช Retry

```javascript
{
  name: "Test Campaign",
  pacing: {
    perMinute: 3,        // 3 ุฑุณุงุฆู ูู ุงูุฏูููุฉ
    delayMin: 15,        // 15 ุซุงููุฉ ูุญุฏ ุฃุฏูู
    delayMax: 30,        // 30 ุซุงููุฉ ูุญุฏ ุฃูุตู
    dailyCap: 50,        // 50 ูุญุงููุฉ ูู ุงูููู
    retryAttempts: 3     // โ 3 ูุญุงููุงุช ููู ุฑุณุงูุฉ ูุงุดูุฉ
  }
}
```

### 3. ูุฑุงูุจุฉ ุงููุชุงุฆุฌ

ุฑุงูุจ Console ููุญุตูู ุนูู ูุนูููุงุช ููุตูุฉ:
- ุนุฏุฏ ุงููุญุงููุงุช ููู ุฑุณุงูุฉ
- ูุนุฏู ุงูุฅุฑุณุงู ุงูุญุงูู
- ุงูุฑุณุงุฆู ุงููุงุฌุญุฉ ูุงููุงุดูุฉ
- ุงูุฃูุฏุงู ุงููุชุฎุทุงุฉ

---

## ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

**ุณ: ูุงุฐุง ูุญุฏุซ ุฅุฐุง ูุดูุช ุฑุณุงูุฉุ**

ุฌ: ูุชู ุฒูุงุฏุฉ `retry_count` ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุงุญูุงู. ุฅุฐุง ูุดูุช ุฌููุน ุงููุญุงููุงุชุ ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู `failed`.

**ุณ: ูู ุชูุญุณุจ ุงููุญุงููุงุช ุงููุงุดูุฉ ูู ุงูุญุฏ ุงูููููุ**

ุฌ: ูุนูุ ูุฃููุง ุชุณุชููู ูู Rate Limit ุงูุฎุงุต ุจู Twitter.

**ุณ: ูุงุฐุง ูู ุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูููุณ ุงููุณุชุฎุฏู ูุฑุชููุ**

ุฌ: ุงููุธุงู ููุญุต ุชููุงุฆูุงู ููุชุฎุทู ุงููุณุชุฎุฏููู ุงูุฐูู ุชู ุงูุฅุฑุณุงู ููู ุจุงููุนู.

**ุณ: ูู ูู ุงูููุช ุจูู ุงููุญุงููุงุชุ**

ุฌ: ูุนุชูุฏ ุนูู `delayMin` ู `delayMax`. ุจุนุฏ ุงููุดูุ ููุงู ุชุฃุฎูุฑ ูุตูุฑ (5 ุซูุงูู) ูุจู ุงููุญุงููุฉ ุงูุชุงููุฉ.

**ุณ: ูู ูููููู ุชุบููุฑ ุนุฏุฏ ุงููุญุงููุงุช ุฃุซูุงุก ุชุดุบูู ุงูุญููุฉุ**

ุฌ: ูุนูุ ููู ูุฌุจ ุฅููุงู ุงูุญููุฉ ูุฅุนุงุฏุฉ ุชุดุบูููุง ูุชุทุจูู ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ.

**ุณ: ูุงุฐุง ูุญุฏุซ ุนูุฏ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุฑุ**

ุฌ: ูุชู ุงุณุชุฆูุงู ุงูุญููุงุช ุงููุดุทุฉ ุชููุงุฆูุงูุ ููุชู ุงูุงุญุชูุงุธ ุจู `retry_count` ููู ูุฏู.

---

## ูุตุงุฆุญ ููุงุณุชุฎุฏุงู ุงูุฃูุซู

### ููุญุณุงุจุงุช ุงูุฌุฏูุฏุฉ
```
Messages per Minute: 2
Delay: 20-40 seconds
Daily Cap: 30
Retry Attempts: 2
```

### ููุญุณุงุจุงุช ุงููุนุชูุฏุฉ
```
Messages per Minute: 3-4
Delay: 15-30 seconds
Daily Cap: 50-60
Retry Attempts: 3
```

### ููุญุณุงุจุงุช ุงูููุซููุฉ
```
Messages per Minute: 5
Delay: 10-20 seconds
Daily Cap: 80-100
Retry Attempts: 3
```

---

**ุชู ุงูุชุญุฏูุซ**: ููุงูุฑ 2025  
**ุงูุฅุตุฏุงุฑ**: 1.2.0 - ูุธุงู Retry ูุงูู
